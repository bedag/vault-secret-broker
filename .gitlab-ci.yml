---
stages:
  - build:app
  - build:docker

.docker-base:
  stage: build:docker
  image: registry-group.mgmtbi.ch/fedora:31
  tags:
    - build
    - privileged
    - overlay
  before_script:
    - mkdir ~/.docker
    - echo "$DOCKER_AUTH_CONFIG" >  ~/.docker/config.json
    - dnf -y install buildah fuse-overlayfs --exclude container-selinux
    - PROXY="--build-arg http_proxy=${http_proxy} --build-arg https_proxy=${https_proxy} --build-arg no_proxy=${no_proxy}"
    - export _BUILDAH_STARTED_IN_USERNS=""
    - export BUILDAH_ISOLATION=chroot
    - buildah bud -f Dockerfile -t vault-secret-broker ${PROXY} .

build:app:
  image: registry-group.mgmtbi.ch/golang:1.13-alpine
  stage: build:app
  tags:
    - build
  script:
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - go mod download
    - go build ./cmd/vault-secret-broker
  artifacts:
    expire_in: 24 h
    paths:
      - vault-secret-broker
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache

build:docker:dev:
  extends: .docker-base
  script:
    - buildah push localhost/vault-secret-broker docker://registry.mgmtbi.ch/bedag_dcs/dev/vault-secret-broker:${CI_COMMIT_REF_SLUG}
  only:
    - branches
  except:
    - master

build:docker:master:
  extends: .docker-base
  script:
    - buildah push localhost/vault-secret-broker docker://registry.mgmtbi.ch/bedag_dcs/vault-secret-broker:latest
  only:
    - master
  except:
    - tags